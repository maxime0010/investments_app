{% extends "base.html" %}

{% block content %}
    <h1>Portfolio Performance (Base Index 100)</h1>

    <!-- Actual Performance Annualized Returns -->
    <div style="margin-bottom: 10px;">
        <h4>Actual Portfolio Annualized Return: {{ actual_portfolio_annualized_return }}%</h4>
        <h4>S&P 500 Annualized Return: {{ sp500_annualized_return_actual }}%</h4>
    </div>

    <!-- Actual Performance Graph -->
    <div style="margin-bottom: 50px;">  <!-- Adds space between the graphs -->
        <h3>Actual Performance (Base Index 100)</h3>
        <canvas id="actualPerformanceChart" style="height: 400px; width: 100%;"></canvas> <!-- Set a fixed height and full width -->
    </div>

    <!-- Simulation-Based Annualized Returns -->
    <div style="margin-bottom: 10px;">
        <h4>Simulated Portfolio Annualized Return: {{ simulated_portfolio_annualized_return }}%</h4>
        <h4>S&P 500 Simulated Annualized Return: {{ sp500_annualized_return_simulation }}%</h4>
    </div>

    <!-- Simulation-Based Performance Graph -->
    <div>
        <h3>Simulation-Based Performance (Base Index 100)</h3>
        <canvas id="simulationPerformanceChart" style="height: 400px; width: 100%;"></canvas> <!-- Set a fixed height and full width -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Define consistent colors for both graphs
        const portfolioColor = 'rgba(75, 192, 192, 1)';  // Blue for the portfolio
        const sp500Color = 'rgba(255, 99, 132, 1)';      // Red for the S&P 500

        // Define gradients for both graphs
        function createGradient(ctx, colorStart, colorEnd) {
            let gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        // Function to normalize data to base index 100 from a specific base value
        function normalizeDataFromBase(data, baseValue) {
            return data.map(function(value) {
                return (value / baseValue) * 100;
            });
        }

        // Function to filter data as of September 1st, 2024
        function filterDataAfterDate(dates, portfolioData, sp500Data, filterDate) {
            var filteredDates = [];
            var filteredPortfolioData = [];
            var filteredSp500Data = [];
            for (var i = 0; i < dates.length; i++) {
                var currentDate = new Date(dates[i]);
                if (currentDate >= filterDate) {
                    filteredDates.push(dates[i]);
                    filteredPortfolioData.push(portfolioData[i]);
                    filteredSp500Data.push(sp500Data[i]);
                }
            }
            return {
                dates: filteredDates,
                portfolioData: filteredPortfolioData,
                sp500Data: filteredSp500Data
            };
        }

        // Actual portfolio and S&P500 data
        var actualPortfolioData = {{ actual_values | tojson }};
        var sp500DataActual = {{ sp500_values_actual | tojson }};
        var datesActual = {{ dates_actual | tojson }};

        // Filter actual data as of September 1st, 2024
        var filterDate = new Date("2024-09-01");
        var filteredActualData = filterDataAfterDate(datesActual, actualPortfolioData, sp500DataActual, filterDate);

        // Set base value for normalization (the portfolio value on September 1st, 2024)
        var basePortfolioValue = filteredActualData.portfolioData[0];  // First data point after September 1st
        var baseSp500Value = filteredActualData.sp500Data[0];  // First S&P500 value after September 1st

        // Normalize data from September 1st, 2024
        var normalizedActualPortfolioData = normalizeDataFromBase(filteredActualData.portfolioData, basePortfolioValue);
        var normalizedSp500DataActual = normalizeDataFromBase(filteredActualData.sp500Data, baseSp500Value);

        // Simulated portfolio and S&P500 data
        var simulatedPortfolioData = normalizeDataFromBase({{ simulation_values | tojson }}, {{ simulation_values | tojson }}[0]); // Normalize from the first point
        var sp500DataSimulation = normalizeDataFromBase({{ sp500_values_simulation | tojson }}, {{ sp500_values_simulation | tojson }}[0]);
        var datesSimulation = {{ dates_simulation | tojson }};

        // Create gradients for actual performance
        var ctxActual = document.getElementById('actualPerformanceChart').getContext('2d');
        var gradientActualPortfolio = createGradient(ctxActual, 'rgba(75, 192, 192, 0.4)', 'rgba(75, 192, 192, 0.0)');
        var gradientSP500Actual = createGradient(ctxActual, 'rgba(255, 99, 132, 0.4)', 'rgba(255, 99, 132, 0.0)');

        // Create gradients for simulation performance
        var ctxSimulation = document.getElementById('simulationPerformanceChart').getContext('2d');
        var gradientSimulatedPortfolio = createGradient(ctxSimulation, 'rgba(75, 192, 192, 0.4)', 'rgba(75, 192, 192, 0.0)');
        var gradientSP500Simulation = createGradient(ctxSimulation, 'rgba(255, 99, 132, 0.4)', 'rgba(255, 99, 132, 0.0)');

        // Minimalistic options (no grid lines) with fixed aspect ratio
        var minimalisticOptions = {
            scales: {
                x: {
                    grid: {
                        display: false  // No grid lines
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    grid: {
                        display: false  // No grid lines
                    },
                    ticks: {
                        // Remove decimals for both charts
                        callback: function(value) {
                            return value.toFixed(0);  // No decimals
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4  // Smooth curves
                },
                point: {
                    radius: 0  // Remove dots (data points)
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Portfolio vs S&P 500 Performance (Base Index 100)',
                    font: {
                        size: 16,
                        style: 'bold'
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: true,  // Ensure fixed aspect ratio
        };

        // Actual Performance Chart with smooth curves, gradients, and minimalistic design
        var actualPerformanceChart = new Chart(ctxActual, {
            type: 'line',
            data: {
                labels: filteredActualData.dates,
                datasets: [
                    {
                        label: 'Actual Portfolio Value (Base Index 100)',
                        data: normalizedActualPortfolioData,
                        borderColor: portfolioColor,   // Same color for portfolio in both graphs
                        backgroundColor: gradientActualPortfolio,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    },
                    {
                        label: 'S&P 500 (Base Index 100)',
                        data: normalizedSp500DataActual,
                        borderColor: sp500Color,   // Same color for S&P 500 in both graphs
                        backgroundColor: gradientSP500Actual,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    }
                ]
            },
            options: minimalisticOptions
        });

        // Modify the x-axis ticks to show weekly increments for the second graph
        var weeklyIncrementsOptions = JSON.parse(JSON.stringify(minimalisticOptions)); // Copy the minimalisticOptions
        weeklyIncrementsOptions.scales.x.time = {
            unit: 'week',  // Use weekly increments
            tooltipFormat: 'MMM D, YYYY',  // Show month, day, and year in tooltips
        };

        // Simulation-Based Performance Chart with weekly increments for x-axis
        var simulationPerformanceChart = new Chart(ctxSimulation, {
            type: 'line',
            data: {
                labels: datesSimulation,
                datasets: [
                    {
                        label: 'Simulated Portfolio Value (Base Index 100)',
                        data: simulatedPortfolioData,
                        borderColor: portfolioColor,   // Same color for portfolio in both graphs
                        backgroundColor: gradientSimulatedPortfolio,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    },
                    {
                        label: 'S&P 500 (Base Index 100)',
                        data: sp500DataSimulation,
                        borderColor: sp500Color,   // Same color for S&P 500 in both graphs
                        backgroundColor: gradientSP500Simulation,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    }
                ]
            },
            options: weeklyIncrementsOptions
        });
    </script>
{% endblock %}

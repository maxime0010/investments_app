{% extends "base.html" %}

{% block content %}
    <h1>Portfolio Performance (Base Index 100)</h1>

    <!-- Actual Performance Graph -->
    <div style="margin-bottom: 50px;">  <!-- Adds space between the graphs -->
        <h3>Actual Performance (Base Index 100)</h3>
        <canvas id="actualPerformanceChart" style="height: 400px; width: 100%;"></canvas> <!-- Set a fixed height and full width -->
    </div>

    <!-- Simulation-Based Performance Graph -->
    <div>
        <h3>Simulation-Based Performance (Base Index 100)</h3>
        <canvas id="simulationPerformanceChart" style="height: 400px; width: 100%;"></canvas> <!-- Set a fixed height and full width -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Function to normalize data to base index 100 from a specific base value
        function normalizeDataFromBase(data, baseValue) {
            return data.map(function(value) {
                return (value / baseValue) * 100;
            });
        }

        // Function to filter data as of September 1st, 2024
        function filterDataAfterDate(dates, portfolioData, sp500Data, filterDate) {
            var filteredDates = [];
            var filteredPortfolioData = [];
            var filteredSp500Data = [];
            for (var i = 0; i < dates.length; i++) {
                var currentDate = new Date(dates[i]);
                if (currentDate >= filterDate) {
                    filteredDates.push(dates[i]);
                    filteredPortfolioData.push(portfolioData[i]);
                    filteredSp500Data.push(sp500Data[i]);
                }
            }
            return {
                dates: filteredDates,
                portfolioData: filteredPortfolioData,
                sp500Data: filteredSp500Data
            };
        }

        // Actual portfolio and S&P500 data
        var actualPortfolioData = {{ actual_values | tojson }};
        var sp500DataActual = {{ sp500_values_actual | tojson }};
        var datesActual = {{ dates_actual | tojson }};

        // Filter actual data as of September 1st, 2024
        var filterDate = new Date("2024-09-01");
        var filteredActualData = filterDataAfterDate(datesActual, actualPortfolioData, sp500DataActual, filterDate);

        // Set base value for normalization (the portfolio value on September 1st, 2024)
        var basePortfolioValue = filteredActualData.portfolioData[0];  // First data point after September 1st
        var baseSp500Value = filteredActualData.sp500Data[0];  // First S&P500 value after September 1st

        // Normalize data from September 1st, 2024
        var normalizedActualPortfolioData = normalizeDataFromBase(filteredActualData.portfolioData, basePortfolioValue);
        var normalizedSp500DataActual = normalizeDataFromBase(filteredActualData.sp500Data, baseSp500Value);

        // Simulated portfolio and S&P500 data
        var simulatedPortfolioData = normalizeDataFromBase({{ simulation_values | tojson }}, {{ simulation_values | tojson }}[0]); // Normalize from the first point
        var sp500DataSimulation = normalizeDataFromBase({{ sp500_values_simulation | tojson }}, {{ sp500_values_simulation | tojson }}[0]);
        var datesSimulation = {{ dates_simulation | tojson }};

        // Create color gradients
        var ctxActual = document.getElementById('actualPerformanceChart').getContext('2d');
        var gradientActualPortfolio = ctxActual.createLinearGradient(0, 0, 0, 400);
        gradientActualPortfolio.addColorStop(0, 'rgba(75, 192, 192, 0.4)');
        gradientActualPortfolio.addColorStop(1, 'rgba(75, 192, 192, 0.0)');

        var gradientSP500Actual = ctxActual.createLinearGradient(0, 0, 0, 400);
        gradientSP500Actual.addColorStop(0, 'rgba(255, 99, 132, 0.4)');
        gradientSP500Actual.addColorStop(1, 'rgba(255, 99, 132, 0.0)');

        var ctxSimulation = document.getElementById('simulationPerformanceChart').getContext('2d');
        var gradientSimulatedPortfolio = ctxSimulation.createLinearGradient(0, 0, 0, 400);
        gradientSimulatedPortfolio.addColorStop(0, 'rgba(54, 162, 235, 0.4)');
        gradientSimulatedPortfolio.addColorStop(1, 'rgba(54, 162, 235, 0.0)');

        var gradientSP500Simulation = ctxSimulation.createLinearGradient(0, 0, 0, 400);
        gradientSP500Simulation.addColorStop(0, 'rgba(255, 99, 132, 0.4)');
        gradientSP500Simulation.addColorStop(1, 'rgba(255, 99, 132, 0.0)');

        // Minimalistic options (no grid lines) with fixed aspect ratio
        var minimalisticOptions = {
            scales: {
                x: {
                    grid: {
                        display: false  // No grid lines
                    },
                    ticks: {
                        autoSkip: true,
                        maxTicksLimit: 10
                    }
                },
                y: {
                    grid: {
                        display: false  // No grid lines
                    },
                    ticks: {
                        // Remove the $ sign, just show the normalized value
                        callback: function(value) {
                            return value.toFixed(2);
                        }
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4  // Smooth curves
                },
                point: {
                    radius: 0  // Remove dots (data points)
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        font: {
                            size: 14
                        }
                    }
                },
                title: {
                    display: true,
                    text: 'Portfolio vs S&P 500 Performance (Base Index 100)',
                    font: {
                        size: 16,
                        style: 'bold'
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: true,  // Ensure fixed aspect ratio
        };

        // Actual Performance Chart with smooth curves, gradients, and minimalistic design
        var actualPerformanceChart = new Chart(ctxActual, {
            type: 'line',
            data: {
                labels: filteredActualData.dates,
                datasets: [
                    {
                        label: 'Actual Portfolio Value (Base Index 100)',
                        data: normalizedActualPortfolioData,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: gradientActualPortfolio,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    },
                    {
                        label: 'S&P 500 (Base Index 100)',
                        data: normalizedSp500DataActual,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: gradientSP500Actual,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    }
                ]
            },
            options: minimalisticOptions
        });

        // Simulation-Based Performance Chart with smooth curves, gradients, and minimalistic design
        var simulationPerformanceChart = new Chart(ctxSimulation, {
            type: 'line',
            data: {
                labels: datesSimulation,
                datasets: [
                    {
                        label: 'Simulated Portfolio Value (Base Index 100)',
                        data: simulatedPortfolioData,
                        borderColor: 'rgba(54, 162, 235, 1)',
                        backgroundColor: gradientSimulatedPortfolio,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    },
                    {
                        label: 'S&P 500 (Base Index 100)',
                        data: sp500DataSimulation,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: gradientSP500Simulation,
                        borderWidth: 2,
                        fill: true  // Enable gradient fill
                    }
                ]
            },
            options: minimalisticOptions
        });
    </script>
{% endblock %}

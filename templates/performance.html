{% extends "base.html" %}

{% block content %}
    <h1>Simulation-Based Portfolio Performance (Base Index 100)</h1>

    <!-- Simulation-Based Annualized Returns -->
    <div style="margin-bottom: 10px;">
        <h4>Simulated Portfolio Annualized Return: <span id="annualizedReturn"></span>%</h4>
        <h4>S&P 500 Simulated Annualized Return: <span id="sp500AnnualizedReturn"></span>%</h4>
    </div>

    <!-- Buttons for selecting the period -->
    <div style="margin-bottom: 20px;">
        <button onclick="filterData('3years')">Last 3 Years</button>
        <button onclick="filterData('12months')">Last 12 Months</button>
        <button onclick="filterData('3months')">Last 3 Months</button>
        <button onclick="filterData('1month')">Last Month</button>
    </div>

    <!-- Simulation-Based Performance Graph -->
    <div>
        <canvas id="simulationPerformanceChart" style="height: 400px; width: 100%;"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const portfolioColor = 'rgba(75, 192, 192, 1)';  // Blue for the portfolio
        const sp500Color = 'rgba(255, 99, 132, 1)';      // Red for the S&P 500

        // Data for the chart
        const fullDates = {{ dates_simulation | tojson }};
        const fullPortfolioValues = {{ simulation_values | tojson }};
        const fullSp500Values = {{ sp500_values_simulation | tojson }};
        
        let chart;
        
        // Function to filter data based on the selected period
        function filterData(period) {
            const endDate = new Date(fullDates[fullDates.length - 1]);
            let startDate;

            // Set the start date based on the selected period
            if (period === '3years') {
                startDate = new Date(endDate);
                startDate.setFullYear(startDate.getFullYear() - 3);
            } else if (period === '12months') {
                startDate = new Date(endDate);
                startDate.setFullYear(startDate.getFullYear() - 1);
            } else if (period === '3months') {
                startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 3);
            } else if (period === '1month') {
                startDate = new Date(endDate);
                startDate.setMonth(startDate.getMonth() - 1);
            }

            // Filter the dates and data
            const filteredDates = [];
            const filteredPortfolioValues = [];
            const filteredSp500Values = [];

            for (let i = 0; i < fullDates.length; i++) {
                const currentDate = new Date(fullDates[i]);
                if (currentDate >= startDate) {
                    filteredDates.push(fullDates[i]);
                    filteredPortfolioValues.push(fullPortfolioValues[i]);
                    filteredSp500Values.push(fullSp500Values[i]);
                }
            }

            // Update the chart and recalculate the annualized return
            updateChart(filteredDates, filteredPortfolioValues, filteredSp500Values);
            updateAnnualizedReturn(filteredPortfolioValues, filteredSp500Values, filteredDates);
        }

        // Function to update the chart with filtered data
        function updateChart(dates, portfolioValues, sp500Values) {
            if (chart) {
                chart.destroy();  // Destroy the existing chart before creating a new one
            }

            const ctx = document.getElementById('simulationPerformanceChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Simulated Portfolio Value (Base Index 100)',
                            data: portfolioValues,
                            borderColor: portfolioColor,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'S&P 500 (Base Index 100)',
                            data: sp500Values,
                            borderColor: sp500Color,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'MMM YYYY',
                            },
                        },
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(0);  // Show whole numbers
                                }
                            }
                        }
                    }
                }
            });
        }

        // Function to calculate and update the annualized return
        function updateAnnualizedReturn(portfolioValues, sp500Values, dates) {
            const startDate = new Date(dates[0]);
            const endDate = new Date(dates[dates.length - 1]);

            const portfolioReturn = calculateAnnualizedReturn(portfolioValues[0], portfolioValues[portfolioValues.length - 1], startDate, endDate);
            const sp500Return = calculateAnnualizedReturn(sp500Values[0], sp500Values[sp500Values.length - 1], startDate, endDate);

            document.getElementById('annualizedReturn').textContent = portfolioReturn.toFixed(1);
            document.getElementById('sp500AnnualizedReturn').textContent = sp500Return.toFixed(1);
        }

        // Helper function to calculate annualized return
        function calculateAnnualizedReturn(startValue, endValue, startDate, endDate) {
            const timeDiffInYears = (endDate - startDate) / (1000 * 60 * 60 * 24 * 365.25);
            if (timeDiffInYears === 0) return 0;
            return ((endValue / startValue) ** (1 / timeDiffInYears) - 1) * 100;
        }

        // Initialize the chart with the full data (e.g., last 3 years by default)
        filterData('3years');
    </script>
{% endblock %}

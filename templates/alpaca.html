{% extends "base.html" %}

{% block title %}Alpaca Account Creation{% endblock %}

{% block content %}
<div class="container">
    <h1>Alpaca Account Creation</h1>
    <p>
        Welcome to the Alpaca account creation page. This feature is currently in <strong>test mode/beta version</strong>. 
        Fill out the form below to create a simulated Alpaca brokerage account for testing purposes.
    </p>
    <p class="text-muted">
        <strong>Note:</strong> This is for <strong>testing purposes only</strong>. No real accounts or transactions will be created.
    </p>

    <!-- Alpaca account creation form -->
    <form id="alpacaForm" class="mt-3">
        <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" id="email" name="email_address" class="form-control" placeholder="example@example.com" required>
        </div>

        <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" id="phone" name="phone_number" class="form-control" placeholder="1234567890" required>
        </div>

        <div class="mb-3">
            <label for="given_name" class="form-label">First Name</label>
            <input type="text" id="given_name" name="given_name" class="form-control" placeholder="John" required>
        </div>

        <div class="mb-3">
            <label for="family_name" class="form-label">Last Name</label>
            <input type="text" id="family_name" name="family_name" class="form-control" placeholder="Doe" required>
        </div>

        <div class="mb-3">
            <label for="date_of_birth" class="form-label">Date of Birth</label>
            <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" required>
        </div>

        <div class="mb-3">
            <label for="street_address" class="form-label">Street Address</label>
            <input type="text" id="street_address" name="street_address" class="form-control" placeholder="123 Main St" required>
        </div>

        <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input type="text" id="city" name="city" class="form-control" placeholder="New York" required>
        </div>

        <div class="mb-3">
            <label for="state" class="form-label">State</label>
            <input type="text" id="state" name="state" class="form-control" placeholder="NY" required>
        </div>

        <div class="mb-3">
            <label for="postal_code" class="form-label">Postal Code</label>
            <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="10001" required>
        </div>

        <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input type="text" id="country" name="country" class="form-control" placeholder="US" required>
        </div>

        <div class="mb-3">
            <label for="tax_id" class="form-label">Tax ID</label>
            <input type="text" id="tax_id" name="tax_id" class="form-control" placeholder="123456789" required>
        </div>

        <div class="mb-3">
            <label for="country_of_tax_residence" class="form-label">Country of Tax Residence</label>
            <input type="text" id="country_of_tax_residence" name="country_of_tax_residence" class="form-control" placeholder="US" required>
        </div>

        <!-- Agreements Section -->
        <div class="mb-3">
            <label class="form-label">Agreements</label>
            <div>
                <input type="checkbox" id="account_agreement" name="agreements" value="account_agreement" required>
                <label for="account_agreement">I accept the Account Agreement.</label>
            </div>
            <div>
                <input type="checkbox" id="customer_agreement" name="agreements" value="customer_agreement" required>
                <label for="customer_agreement">I accept the Customer Agreement.</label>
            </div>
            <div>
                <input type="checkbox" id="margin_agreement" name="agreements" value="margin_agreement" required>
                <label for="margin_agreement">I accept the Margin Agreement.</label>
            </div>
        </div>

        <button type="button" id="submitButton" class="btn btn-warning btn-lg">Create Alpaca Test Account</button>
    </form>

    <p id="responseMessage" class="mt-3"></p>
</div>

<script>
    document.getElementById('submitButton').addEventListener('click', async () => {
        const form = document.getElementById('alpacaForm');
        const formData = new FormData(form);
        const agreements = [];

        // Collect checked agreements
        form.querySelectorAll('input[name="agreements"]:checked').forEach((checkbox) => {
            agreements.push(checkbox.value);
        });

        const jsonData = {};
        formData.forEach((value, key) => {
            jsonData[key] = value;
        });

        const payload = {
            contact: {
                email_address: jsonData.email_address,
                phone_number: jsonData.phone_number,
                street_address: jsonData.street_address,
                city: jsonData.city,
                state: jsonData.state,
                postal_code: jsonData.postal_code,
                country: jsonData.country,
            },
            identity: {
                given_name: jsonData.given_name,
                family_name: jsonData.family_name,
                date_of_birth: jsonData.date_of_birth,
                tax_id: jsonData.tax_id,
                tax_id_type: 'SSN',
                country_of_tax_residence: jsonData.country_of_tax_residence,
            },
            disclosures: {
                is_control_person: jsonData.is_control_person === 'true',
                is_affiliated_exchange_or_finra: jsonData.is_affiliated_exchange_or_finra === 'true',
                is_politically_exposed: jsonData.is_politically_exposed === 'true',
                immediate_family_exposed: jsonData.immediate_family_exposed === 'true',
            },
            agreements, // Agreements as an array
        };

        console.log('Payload:', JSON.stringify(payload, null, 2)); // Debugging payload

        try {
            const response = await fetch('/create_account', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            const result = await response.json();
            const messageElement = document.getElementById('responseMessage');

            if (response.ok) {
                messageElement.textContent = `Account created successfully: ${JSON.stringify(result)}`;
                messageElement.className = 'text


            } else {
                messageElement.textContent = `Error: ${result.error || 'Unknown error'}`;
                messageElement.className = 'text-danger';
            }
        } catch (error) {
            console.error('Error creating account:', error);
            document.getElementById('responseMessage').textContent = `Error: ${error.message}`;
        }
    });
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Alpaca Account Creation{% endblock %}

{% block content %}
<div class="container">
    <h1>Alpaca Account Creation</h1>
    <p>
        Welcome to the Alpaca account creation page. This feature is currently in <strong>test mode/beta version</strong>. 
        Fill out the form below to create a simulated Alpaca brokerage account for testing purposes.
    </p>
    <p class="text-muted">
        <strong>Note:</strong> This is for <strong>testing purposes only</strong>. No real accounts or transactions will be created.
    </p>

    <form id="alpacaForm" class="mt-3">
        <!-- Contact Information -->
        <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" id="email" name="email_address" class="form-control" placeholder="example@example.com" required>
        </div>
        <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" id="phone" name="phone_number" class="form-control" placeholder="1234567890" required>
        </div>
        <div class="mb-3">
            <label for="street_address" class="form-label">Street Address</label>
            <input type="text" id="street_address" name="street_address" class="form-control" placeholder="123 Main St" required>
        </div>
        <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input type="text" id="city" name="city" class="form-control" placeholder="New York" required>
        </div>
        <div class="mb-3">
            <label for="state" class="form-label">State</label>
            <input type="text" id="state" name="state" class="form-control" placeholder="NY" required>
        </div>
        <div class="mb-3">
            <label for="postal_code" class="form-label">Postal Code</label>
            <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="10001" required>
        </div>
        <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input type="text" id="country" name="country" class="form-control" placeholder="US" required>
        </div>

        <!-- Identity Information -->
        <div class="mb-3">
            <label for="given_name" class="form-label">First Name</label>
            <input type="text" id="given_name" name="given_name" class="form-control" placeholder="John" required>
        </div>
        <div class="mb-3">
            <label for="family_name" class="form-label">Last Name</label>
            <input type="text" id="family_name" name="family_name" class="form-control" placeholder="Doe" required>
        </div>
        <div class="mb-3">
            <label for="date_of_birth" class="form-label">Date of Birth</label>
            <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="tax_id" class="form-label">Tax ID</label>
            <input type="text" id="tax_id" name="tax_id" class="form-control" placeholder="123-45-6789" required>
        </div>
        <div class="mb-3">
            <label for="tax_id_type" class="form-label">Tax ID Type</label>
            <select id="tax_id_type" name="tax_id_type" class="form-control" required>
                <option value="USA_SSN">USA SSN</option>
                <option value="ITIN">ITIN</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="country_of_citizenship" class="form-label">Country of Citizenship</label>
            <input type="text" id="country_of_citizenship" name="country_of_citizenship" class="form-control" placeholder="US" required>
        </div>
        <div class="mb-3">
            <label for="country_of_tax_residence" class="form-label">Country of Tax Residence</label>
            <input type="text" id="country_of_tax_residence" name="country_of_tax_residence" class="form-control" placeholder="US" required>
        </div>
        <div class="mb-3">
            <label for="funding_source" class="form-label">Funding Source</label>
            <select id="funding_source" name="funding_source" class="form-control" multiple required>
                <option value="employment_income">Employment Income</option>
                <option value="inheritance">Inheritance</option>
                <option value="savings">Savings</option>
            </select>
        </div>

        <!-- Financial and Investment Information -->
        <div class="mb-3">
            <label for="liquidity_needs" class="form-label">Liquidity Needs</label>
            <select id="liquidity_needs" name="liquidity_needs" class="form-control" required>
                <option value="does_not_matter">Does Not Matter</option>
                <option value="immediate">Immediate</option>
            </select>
        </div>
<div class="mb-3">
    <label for="investment_experience_with_stocks" class="form-label">Investment Experience with Stocks</label>
    <select id="investment_experience_with_stocks" name="investment_experience_with_stocks" class="form-control" required>
        <option value="none">None</option>
        <option value="limited">Limited</option>
        <option value="intermediate">Intermediate</option>
        <option value="sophisticated">Sophisticated</option>
        <option value="1_to_5_years">1 to 5 years</option>
        <option value="over_5_years">Over 5 years</option>
    </select>
</div>
<div class="mb-3">
    <label for="investment_experience_with_options" class="form-label">Investment Experience with Options</label>
    <select id="investment_experience_with_options" name="investment_experience_with_options" class="form-control" required>
        <option value="none">None</option>
        <option value="limited">Limited</option>
        <option value="intermediate">Intermediate</option>
        <option value="sophisticated">Sophisticated</option>
        <option value="1_to_5_years">1 to 5 years</option>
        <option value="over_5_years">Over 5 years</option>
    </select>
</div>

        <div class="mb-3">
            <label for="risk_tolerance" class="form-label">Risk Tolerance</label>
            <select id="risk_tolerance" name="risk_tolerance" class="form-control" required>
                <option value="conservative">Conservative</option>
                <option value="moderate">Moderate</option>
                <option value="aggressive">Aggressive</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="investment_objective" class="form-label">Investment Objective</label>
            <select id="investment_objective" name="investment_objective" class="form-control" required>
                <option value="capital_preservation">Capital Preservation</option>
                <option value="growth">Growth</option>
                <option value="market_speculation">Market Speculation</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="investment_time_horizon" class="form-label">Investment Time Horizon</label>
            <select id="investment_time_horizon" name="investment_time_horizon" class="form-control" required>
                <option value="less_than_1_year">Less than 1 year</option>
                <option value="1_to_3_years">1 to 3 years</option>
                <option value="3_to_5_years">3 to 5 years</option>
                <option value="more_than_10_years">More than 10 years</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="marital_status" class="form-label">Marital Status</label>
            <select id="marital_status" name="marital_status" class="form-control" required>
                <option value="SINGLE">Single</option>
                <option value="MARRIED">Married</option>
                <option value="DIVORCED">Divorced</option>
                <option value="WIDOWED">Widowed</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="number_of_dependents" class="form-label">Number of Dependents</label>
            <input type="number" id="number_of_dependents" name="number_of_dependents" class="form-control" required>
        </div>

        <!-- Disclosures -->
        <div class="mb-3">
            <label class="form-label">Disclosures</label>
            <div>
                <input type="checkbox" id="is_control_person" name="is_control_person" value="true" required>
                <label for="is_control_person">Are you a control person?</label>
            </div>
            <div>
                <input type="checkbox" id="is_affiliated_exchange_or_finra" name="is_affiliated_exchange_or_finra" value="true" required>
                <label for="is_affiliated_exchange_or_finra">Are you affiliated with FINRA or exchanges?</label>
            </div>
            <div>
                <input type="checkbox" id="is_affiliated_exchange_or_iiroc" name="is_affiliated_exchange_or_iiroc" value="true" required>
                <label for="is_affiliated_exchange_or_iiroc">Are you affiliated with IIROC?</label>
            </div>
            <div>
                <input type="checkbox" id="is_politically_exposed" name="is_politically_exposed" value="true" required>
                <label for="is_politically_exposed">Are you politically exposed?</label>
            </div>
            <div>
                <input type="checkbox" id="immediate_family_exposed" name="immediate_family_exposed" value="true" required>
                <label for="immediate_family_exposed">Is your immediate family politically exposed?</label>
            </div>
        </div>

        <button type="button" id="submitButton" class="btn btn-warning btn-lg">Create Alpaca Test Account</button>
    </form>

    <p id="responseMessage" class="mt-3"></p>
</div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('submitButton').addEventListener('click', async () => {
        const form = document.getElementById('alpacaForm');
        const formData = new FormData(form);

        const streetAddressArray = [formData.get('street_address')];
        const fundingSourceArray = Array.from(formData.getAll('funding_source'));

        const agreements = [
            {
                agreement: 'customer_agreement',
                signed_at: new Date().toISOString(),
                ip_address: '127.0.0.1'
            },
            {
                agreement: 'margin_agreement',
                signed_at: new Date().toISOString(),
                ip_address: '127.0.0.1'
            }
        ];

        const payload = {
            contact: {
                email_address: formData.get('email_address'),
                phone_number: formData.get('phone_number'),
                street_address: streetAddressArray,
                city: formData.get('city'),
                state: formData.get('state'),
                postal_code: formData.get('postal_code'),
                country: formData.get('country'),
            },
            identity: {
                given_name: formData.get('given_name'),
                family_name: formData.get('family_name'),
                date_of_birth: formData.get('date_of_birth'),
                tax_id: formData.get('tax_id'),
                tax_id_type: formData.get('tax_id_type'),
                country_of_citizenship: formData.get('country_of_citizenship'),
                country_of_birth: formData.get('country_of_birth'),
                country_of_tax_residence: formData.get('country_of_tax_residence'),
                funding_source: fundingSourceArray,
                annual_income_min: Number(formData.get('annual_income_min')), // Convert to number
                annual_income_max: Number(formData.get('annual_income_max')), // Convert to number
                total_net_worth_min: Number(formData.get('total_net_worth_min')), // Convert to number
                total_net_worth_max: Number(formData.get('total_net_worth_max')), // Convert to number
                liquid_net_worth_min: Number(formData.get('liquid_net_worth_min')), // Convert to number
                liquid_net_worth_max: Number(formData.get('liquid_net_worth_max')), // Convert to number
                liquidity_needs: formData.get('liquidity_needs'),
                investment_experience_with_stocks: formData.get('investment_experience_with_stocks'),
                investment_experience_with_options: formData.get('investment_experience_with_options'),
                risk_tolerance: formData.get('risk_tolerance'),
                investment_objective: formData.get('investment_objective'),
                investment_time_horizon: formData.get('investment_time_horizon'),
                marital_status: formData.get('marital_status'),
                number_of_dependents: Number(formData.get('number_of_dependents')), // Convert to number
            },
            disclosures: {
                is_control_person: formData.get('is_control_person') === 'true',
                is_affiliated_exchange_or_finra: formData.get('is_affiliated_exchange_or_finra') === 'true',
                is_affiliated_exchange_or_iiroc: formData.get('is_affiliated_exchange_or_iiroc') === 'true',
                is_politically_exposed: formData.get('is_politically_exposed') === 'true',
                immediate_family_exposed: formData.get('immediate_family_exposed') === 'true',
            },
            agreements,
        };

        console.log('Payload:', payload); // Debugging

        try {
            const response = await fetch('/create_account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            const messageElement = document.getElementById('responseMessage');
if (response.ok) {
    const result = await response.json();

    // Redirect to the dashboard with account ID as a query parameter
    window.location.href = `/dashboard?account_id=${result.id}`;
} else {
    const result = await response.json();
    messageElement.textContent = `Error: ${result.error || 'Unknown error'}`;
    messageElement.className = 'text-danger';
}

        } catch (error) {
            console.error('Error:', error);
            document.getElementById('responseMessage').textContent = `Error: ${error.message}`;
        }
    });
});



</script>

{% endblock %}

{% extends "base.html" %}

{% block title %}Alpaca Account Creation{% endblock %}

{% block content %}
<div class="container">
    <h1>Alpaca Account Creation</h1>
    <p>
        Welcome to the Alpaca account creation page. This feature is currently in <strong>test mode/beta version</strong>. 
        Fill out the form below to create a simulated Alpaca brokerage account for testing purposes.
    </p>
    <p class="text-muted">
        <strong>Note:</strong> This is for <strong>testing purposes only</strong>. No real accounts or transactions will be created.
    </p>

    <form id="alpacaForm" class="mt-3">
        <!-- Contact Information -->
        <div class="mb-3">
            <label for="email" class="form-label">Email Address</label>
            <input type="email" id="email" name="email_address" class="form-control" placeholder="example@example.com" required>
        </div>
        <div class="mb-3">
            <label for="phone" class="form-label">Phone Number</label>
            <input type="tel" id="phone" name="phone_number" class="form-control" placeholder="1234567890" required>
        </div>
        <div class="mb-3">
            <label for="street_address" class="form-label">Street Address</label>
            <input type="text" id="street_address" name="street_address" class="form-control" placeholder="123 Main St" required>
        </div>
        <div class="mb-3">
            <label for="city" class="form-label">City</label>
            <input type="text" id="city" name="city" class="form-control" placeholder="New York" required>
        </div>
        <div class="mb-3">
            <label for="state" class="form-label">State</label>
            <input type="text" id="state" name="state" class="form-control" placeholder="NY" required>
        </div>
        <div class="mb-3">
            <label for="postal_code" class="form-label">Postal Code</label>
            <input type="text" id="postal_code" name="postal_code" class="form-control" placeholder="10001" required>
        </div>
        <div class="mb-3">
            <label for="country" class="form-label">Country</label>
            <input type="text" id="country" name="country" class="form-control" placeholder="US" required>
        </div>

        <!-- Identity Information -->
        <div class="mb-3">
            <label for="given_name" class="form-label">First Name</label>
            <input type="text" id="given_name" name="given_name" class="form-control" placeholder="John" required>
        </div>
        <div class="mb-3">
            <label for="family_name" class="form-label">Last Name</label>
            <input type="text" id="family_name" name="family_name" class="form-control" placeholder="Doe" required>
        </div>
        <div class="mb-3">
            <label for="date_of_birth" class="form-label">Date of Birth</label>
            <input type="date" id="date_of_birth" name="date_of_birth" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="tax_id" class="form-label">Tax ID</label>
            <input type="text" id="tax_id" name="tax_id" class="form-control" placeholder="123-45-6789" required>
        </div>
        <div class="mb-3">
            <label for="tax_id_type" class="form-label">Tax ID Type</label>
            <select id="tax_id_type" name="tax_id_type" class="form-control" required>
                <option value="USA_SSN">USA SSN</option>
                <option value="ITIN">ITIN</option>
            </select>
        </div>
        <div class="mb-3">
            <label for="country_of_citizenship" class="form-label">Country of Citizenship</label>
            <input type="text" id="country_of_citizenship" name="country_of_citizenship" class="form-control" placeholder="US" required>
        </div>
        <div class="mb-3">
            <label for="country_of_birth" class="form-label">Country of Birth</label>
            <input type="text" id="country_of_birth" name="country_of_birth" class="form-control" placeholder="US" required>
        </div>
        <div class="mb-3">
            <label for="funding_source" class="form-label">Funding Source</label>
            <select id="funding_source" name="funding_source" class="form-control" multiple required>
                <option value="employment_income">Employment Income</option>
                <option value="inheritance">Inheritance</option>
                <option value="savings">Savings</option>
            </select>
        </div>

        <!-- Financial Information -->
        <div class="mb-3">
            <label for="annual_income_min" class="form-label">Annual Income (Min)</label>
            <input type="number" id="annual_income_min" name="annual_income_min" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="annual_income_max" class="form-label">Annual Income (Max)</label>
            <input type="number" id="annual_income_max" name="annual_income_max" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="total_net_worth_min" class="form-label">Total Net Worth (Min)</label>
            <input type="number" id="total_net_worth_min" name="total_net_worth_min" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="total_net_worth_max" class="form-label">Total Net Worth (Max)</label>
            <input type="number" id="total_net_worth_max" name="total_net_worth_max" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="liquid_net_worth_min" class="form-label">Liquid Net Worth (Min)</label>
            <input type="number" id="liquid_net_worth_min" name="liquid_net_worth_min" class="form-control" required>
        </div>
        <div class="mb-3">
            <label for="liquid_net_worth_max" class="form-label">Liquid Net Worth (Max)</label>
            <input type="number" id="liquid_net_worth_max" name="liquid_net_worth_max" class="form-control" required>
        </div>

        <!-- Agreements -->
        <div class="mb-3">
            <label class="form-label">Agreements</label>
            <div>
                <input type="checkbox" id="customer_agreement" name="agreements" value="customer_agreement" required>
                <label for="customer_agreement">I accept the Customer Agreement.</label>
            </div>
            <div>
                <input type="checkbox" id="margin_agreement" name="agreements" value="margin_agreement" required>
                <label for="margin_agreement">I accept the Margin Agreement.</label>
            </div>
        </div>

        <button type="button" id="submitButton" class="btn btn-warning btn-lg">Create Alpaca Test Account</button>
    </form>

    <p id="responseMessage" class="mt-3"></p>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('submitButton').addEventListener('click', async () => {
            const form = document.getElementById('alpacaForm');
            const formData = new FormData(form);

            // Convert multi-line inputs or special fields as needed
            const streetAddressArray = [formData.get('street_address')];
            const fundingSourceArray = Array.from(formData.getAll('funding_source'));

            const agreements = [
                {
                    agreement: 'customer_agreement',
                    signed_at: new Date().toISOString(),
                    ip_address: '127.0.0.1'
                },
                {
                    agreement: 'margin_agreement',
                    signed_at: new Date().toISOString(),
                    ip_address: '127.0.0.1'
                }
            ];

            // Build the payload
            const payload = {
                contact: {
                    email_address: formData.get('email_address'),
                    phone_number: formData.get('phone_number'),
                    street_address: streetAddressArray,
                    city: formData.get('city'),
                    state: formData.get('state'),
                    postal_code: formData.get('postal_code'),
                    country: formData.get('country'),
                },
                identity: {
                    given_name: formData.get('given_name'),
                    family_name: formData.get('family_name'),
                    date_of_birth: formData.get('date_of_birth'),
                    tax_id: formData.get('tax_id'), // Ensure tax_id is included
                    tax_id_type: formData.get('tax_id_type'), // Ensure tax_id_type is included
                    country_of_citizenship: formData.get('country_of_citizenship'),
                    country_of_birth: formData.get('country_of_birth'),
                    funding_source: fundingSourceArray,
                    annual_income_min: formData.get('annual_income_min'),
                    annual_income_max: formData.get('annual_income_max'),
                    total_net_worth_min: formData.get('total_net_worth_min'),
                    total_net_worth_max: formData.get('total_net_worth_max'),
                    liquid_net_worth_min: formData.get('liquid_net_worth_min'),
                    liquid_net_worth_max: formData.get('liquid_net_worth_max'),
                },
                agreements,
            };

            console.log('Payload:', payload); // Debugging

            try {
                const response = await fetch('/create_account', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                const messageElement = document.getElementById('responseMessage');
                if (response.ok) {
                    const result = await response.json();
                    messageElement.textContent = `Account created successfully: ${JSON.stringify(result)}`;
                    messageElement.className = 'text-success';
                } else {
                    const result = await response.json();
                    messageElement.textContent = `Error: ${result.error || 'Unknown error'}`;
                    messageElement.className = 'text-danger';
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('responseMessage').textContent = `Error: ${error.message}`;
            }
        });
    });
</script>

{% endblock %}
